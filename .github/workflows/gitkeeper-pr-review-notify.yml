name: GitKeeper ‚Äì Notify Reviewers via Slack DM

on:
  pull_request:
    types: [review_requested]

jobs:
  notifyReviewers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        
      - name: Notify assigned reviewers
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REPO: ${{ github.repository }}
          REQUESTED_REVIEWERS: ${{ toJson(github.event.pull_request.requested_reviewers) }}
        run: |
          MAP_FILE=".github/slack-reviewer-map.json"

          # Lee los logins de reviewers desde la variable de entorno
          REVIEWERS=$(echo "$REQUESTED_REVIEWERS" | jq -r '.[].login')

          for reviewer in $REVIEWERS; do
            SLACK_ID=$(jq -r --arg user "$reviewer" '.[$user]' "$MAP_FILE")
            if [ "$SLACK_ID" == "null" ] || [ -z "$SLACK_ID" ]; then
              echo "No Slack ID para $reviewer"
              continue
            fi

          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-type: application/json" \
            --data "{
              \"channel\": \"$SLACK_ID\",
              \"attachments\": [
                {
                  \"color\": \"#2EB67D\",
                  \"blocks\": [
                    { \"type\": \"header\", \"text\": { \"type\": \"plain_text\", \"text\": \"üîç Nueva Review Asignada\", \"emoji\": true } },
                    { \"type\": \"section\", \"fields\": [
                      { \"type\": \"mrkdwn\", \"text\": \"*Repositorio:* $REPO\" },
                      { \"type\": \"mrkdwn\", \"text\": \"*Reviewer:* $reviewer\" }
                    ]},
                    { \"type\": \"actions\", \"elements\": [
                      { \"type\": \"button\", \"text\": { \"type\": \"plain_text\", \"text\": \"Ver PR\" }, \"url\": \"$PR_URL\", \"style\": \"primary\" }
                    ]}
                  ]
                }
              ]
          }"
          done
